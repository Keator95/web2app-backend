import express,{Request,Response,NextFunction} from 'express';import cors from 'cors';import dotenv from 'dotenv';import {PrismaClient,TenantRole} from '@prisma/client';import bcrypt from 'bcryptjs';import jwt from 'jsonwebtoken';dotenv.config();const app=express();const prisma=new PrismaClient();const PORT=Number(process.env.PORT)||4000;const JWT_SECRET=process.env.JWT_SECRET||'dev-secret-change-me';app.use(cors());app.use(express.json());function createToken(u:any):string{return jwt.sign({sub:u.id,email:u.email},JWT_SECRET,{expiresIn:'7d'});}interface AuthedRequest extends Request{user?:{id:string;email:string};}function authMiddleware(req:AuthedRequest,res:Response,next:NextFunction){const auth=req.headers['authorization'];if(!auth||!auth.startsWith('Bearer ')){return res.status(401).json({error:'Missing auth token'});}const t=auth.substring(7);try{const d:any=jwt.verify(t,JWT_SECRET);req.user={id:d.sub,email:d.email};next();}catch(e){return res.status(401).json({error:'Invalid or expired token'});}}async function logAudit(tId:string|null,uId:string|null,action:string,details?:any){try{await prisma.auditLog.create({data:{tenantId:tId||undefined,userId:uId||undefined,action,details,},});}catch(e){console.error('Failed to log audit',e);}}async function getFirstTenantForUser(uId:string){const tu=await prisma.tenantUser.findFirst({where:{userId:uId},include:{tenant:true},});return tu?.tenant||null;}app.get('/health',(_req:Request,res:Response)=>{res.json({status:'ok'});});app.post('/auth/register',async(req:Request,res:Response)=>{try{const{email,password,name,storeName}=req.body||{};if(!email||!password){return res.status(400).json({error:'Missing email or password'});}const existing=await prisma.user.findUnique({where:{email}});if(existing){return res.status(400).json({error:'Email already registered'});}const hash=await bcrypt.hash(password,10);const user=await prisma.user.create({data:{email,password:hash,name,},});const tenant=await prisma.tenant.create({data:{name:storeName||`${name||email}'s Store`,},});await prisma.tenantUser.create({data:{tenantId:tenant.id,userId:user.id,role:TenantRole.OWNER,},});const token=createToken(user);res.json({user:{id:user.id,email:user.email,name:user.name},tenant,token,});}catch(err){console.error('Register error',err);res.status(500).json({error:'Internal server error'});}});app.post('/auth/login',async(req:Request,res:Response)=>{try{const{email,password}=req.body||{};if(!email||!password){return res.status(400).json({error:'Missing email or password'});}const user=await prisma.user.findUnique({where:{email}});if(!user){return res.status(401).json({error:'Invalid credentials'});}const valid=await bcrypt.compare(password,user.password);if(!valid){return res.status(401).json({error:'Invalid credentials'});}const token=createToken(user);const tenant=await getFirstTenantForUser(user.id);res.json({user:{id:user.id,email:user.email,name:user.name},tenant,token,});}catch(err){console.error('Login error',err);res.status(500).json({error:'Internal server error'});}});app.get('/tenants/me',authMiddleware,async(req:AuthedRequest,res:Response)=>{try{const userId=req.user!.id;const tenant=await getFirstTenantForUser(userId);if(!tenant){return res.status(404).json({error:'No tenant for user'});}res.json(tenant);}catch(err){console.error('Get tenant error',err);res.status(500).json({error:'Internal server error'});}});app.post('/tenants',authMiddleware,async(req:AuthedRequest,res:Response)=>{try{const userId=req.user!.id;const{name}=req.body||{};if(!name){return res.status(400).json({error:'Missing tenant name'});}const tenant=await prisma.tenant.create({data:{name}});await prisma.tenantUser.create({data:{tenantId:tenant.id,userId,role:TenantRole.OWNER,},});await logAudit(tenant.id,userId,'tenant_created',{name});res.json(tenant);}catch(err){console.error('Create tenant error',err);res.status(500).json({error:'Internal server error'});}});app.get('/config/me',authMiddleware,async(req:AuthedRequest,res:Response)=>{try{const userId=req.user!.id;const tenant=await getFirstTenantForUser(userId);if(!tenant){return res.status(404).json({error:'No tenant for user'});}const cfg=await prisma.appConfig.findFirst({where:{tenantId:tenant.id},orderBy:{version:'desc'},});if(!cfg){return res.json({theme:{},tabs:[]});}res.json(cfg.json);}catch(err){console.error('Get config error',err);res.status(500).json({error:'Internal server error'});}});app.post('/config/me',authMiddleware,async(req:AuthedRequest,res:Response)=>{try{const userId=req.user!.id;const tenant=await getFirstTenantForUser(userId);if(!tenant){return res.status(404).json({error:'No tenant for user'});}const json=req.body?.config;if(!json){return res.status(400).json({error:'Missing config in body'});}const last=await prisma.appConfig.findFirst({where:{tenantId:tenant.id},orderBy:{version:'desc'},select:{version:true},});const nextVersion=(last?.version||0)+1;const created=await prisma.appConfig.create({data:{tenantId:tenant.id,version:nextVersion,json,},});await logAudit(tenant.id,userId,'app_config_updated',{version:nextVersion});res.json(created.json);}catch(err){console.error('Update config error',err);res.status(500).json({error:'Internal server error'});}});app.post('/ai/generate-config',authMiddleware,async(req:AuthedRequest,res:Response)=>{try{const userId=req.user!.id;const tenant=await getFirstTenantForUser(userId);if(!tenant){return res.status(404).json({error:'No tenant for user'});}const{storeUrl}=req.body||{};if(!storeUrl){return res.status(400).json({error:'Missing storeUrl'});}const config={theme:{primary:'#FF6600',accent:'#000000',},tabs:[{id:'home',label:'Home',type:'web',url:storeUrl},{id:'shop',label:'Shop',type:'web',url:`${storeUrl.replace(/\/$/,'')}/collections/all`},],};const last=await prisma.appConfig.findFirst({where:{tenantId:tenant.id},orderBy:{version:'desc'},select:{version:true},});const nextVersion=(last?.version||0)+1;const created=await prisma.appConfig.create({data:{tenantId:tenant.id,version:nextVersion,json:config,},});await logAudit(tenant.id,userId,'ai_generated_config',{storeUrl,version:nextVersion});res.json(created.json);}catch(err){console.error('AI generate config error',err);res.status(500).json({error:'Internal server error'});}});app.post('/push/register-device',async(req:Request,res:Response)=>{try{const tId=(req.headers['x-tenant-id']as string)||'';const{deviceToken,platform}=req.body||{};if(!tId||!deviceToken||!platform){return res.status(400).json({error:'Missing tenantId header or deviceToken/platform in body'});}await prisma.pushDevice.upsert({where:{tenantId_deviceToken:{tenantId:tId,deviceToken,},},update:{platform},create:{tenantId:tId,deviceToken,platform,},});await logAudit(tId,null,'push_device_registered',{platform});res.json({success:true});}catch(err){console.error('Register device error',err);res.status(500).json({error:'Internal server error'});}});app.post('/push/campaigns',authMiddleware,async(req:AuthedRequest,res:Response)=>{try{const userId=req.user!.id;const tenant=await getFirstTenantForUser(userId);if(!tenant){return res.status(404).json({error:'No tenant for user'});}const{title,body,triggerType}=req.body||{};if(!title||!body){return res.status(400).json({error:'Missing title or body'});}const campaign=await prisma.pushCampaign.create({data:{tenantId:tenant.id,title,body,triggerType:triggerType||'manual',createdByUserId:userId,},});await logAudit(tenant.id,userId,'push_campaign_created',{campaignId:campaign.id});res.json(campaign);}catch(err){console.error('Create campaign error',err);res.status(500).json({error:'Internal server error'});}});app.post('/events',async(req:Request,res:Response)=>{try{const tId=(req.headers['x-tenant-id']as string)||'';const{type,payload}=req.body||{};if(!tId||!type){return res.status(400).json({error:'Missing tenantId header or type in body'});}const event=await prisma.event.create({data:{tenantId:tId,type,payload:payload||{},},});res.json({success:true,id:event.id});}catch(err){console.error('Create event error',err);res.status(500).json({error:'Internal server error'});}});app.listen(PORT,()=>{console.log(`Server listening on port ${PORT}`);});
